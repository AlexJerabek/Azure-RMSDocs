---
title: How to - process email messages using MIP SDK
description: This article will help you understand the scenario of how to use MIP SDK file API to process .msg and .rpmsg files.
author: msmbaldwin
ms.service: information-protection
ms.topic: conceptual
ms.date: 04/08/2020
ms.author: mbaldwin
---

# File API email message file processing

MIP SDK supports decryption and encryption for email messages. Both .msg files, generated by Outlook or Exchange, and .rpmsg files are supported by the SDK although via slightly different methods. 

Common use cases for this scenario are:

- Decrypt mail and attachments for DLP inspection
- Publish protected messages directly from line-of-business applications
- Decrypt, modify, and reprotect messages in transit

## MSG File Support Statement

MIP SDK supports protection application and removal for MSG files. Given the variety of encoding types and variables in the format over the years, it's not possible to guarantee that MIP SDK can remove protection from *all* MSG files. The following section describes supportability for MSG files from various sources.

- Removing protection from MSG files that were protected with MIP SDK is fully supported.
- Removing protection from MSG files created by [currently supported](https://docs.microsoft.com/lifecycle/faq/office#:~:text=For%20Office%202019%2C%20Microsoft%20will%20provide%205%20years,align%20with%20the%20support%20period%20for%20Office%202016.) versions of the Outlook client is fully supported.
- Removing protection from MSG files created by out-of-support versions of the Outlook client is supported on a best-effort basis. 

## File API operations for .msg files

File API supports protection operations for .msg files and in manner identical to any other file type, except that the SDK needs the application to enable MSG feature flag. 

> [!IMPORTANT]
> Labeling operations for .msg files are not currently supported.

As discussed previously, instantiation of `mip::FileEngine` requires a settings object, `mip::FileEngineSettings`. `mip::FileEngineSettings` can be used to pass in parameters for custom settings to meet specific application needs. To enable MIP SDK to process MSG files, the `CustomSettings` property of the `FileEngineSettings` object is used to set the flag for `enable_msg_file_type` to enable processing of .msg files.

The .msg file protection operations pseudocode may look like:

- Set `enable_msg_file_type` flag in `mip::FileEngineSettings` and add the `mip::FileEngine` to `mip::FileProfile`.
- Use Protection API to List protection templates available to the user.
- Construct `mip::FileHandler` that points to the file to be protected.
- Select a template to protect and set protection to the file using `mip::FileHandler`'s `SetProtection` method.

Refer to [Quickstart: List templates](quick-protection-list-templates-cpp.md) for information on how to list protection templates.

## File API operations for .rpmsg files

MIP SDK doesn't support MIME-compliant (commonly EML) messages. Rather, the SDK exposes an inspection function that can decrypt the embedded **message.rpmsg** file and present a set of byte streams as output. It's up to the SDK consumer to extract the message.rpmsg file and pass it to the API. Variations of this file name exist for Office Message Encryption scenarios and the API will also accept message_v2, v3, or v4 files.

Commonly, mail gateway and data loss prevention (DLP) services handle MIME compliant messages while email is in transit. When mail is protected, the contents of the message are stored in an attachment, *message.rpmsg*. This attachment contains the encrypted email body and any attachments that were part of the original message. The *rpmsg* file is then attached to a plaintext wrapper email and sent to the mail service. Once that message leaves the Exchange or Exchange Online boundary, it's in the MIME-compliant format so that it can be sent to its destination.

In most cases, the DLP partner needs to get the attachments and plaintext bytes from the message to inspect and evaluate against DLP policies. The inspect API takes the message.rpmsg as input and returns byte streams as output. These byte streams contain the plaintext bytes of the message and the attachments. Itâ€™s up to the application developer to handle these streams and to do something useful with them (inspect, recursively decrypt, etc.).

The `Inspect` API is implemented through a class, `mip::FileInspector`, which exposes operations for inspecting supported file types. `mip::MsgInspector` which extends `mip::FileInspector`, exposes decryption operations specific to rpmsg file format. MIP SDK does not support any publishing scenarios for *message.rpmsg* files. Additionally, the `FileHandler::RemoveProtection()` API does not support message.rpmsg files. *Message.rpmsg* files can be decrypted only for inspection and **will not output a valid, usable file**. If your application requires a file output, you must pass in an MSG file and remove protection from that object.  

`mip::MsgInspector` class exposes below members:

```cpp
public const std::vector<uint8_t>& GetBody()
public BodyType GetBodyType() const
public BodyType GetBodyType() const
public InspectorType GetInspectorType() const
public std::shared_ptr<Stream> GetFileStream() const
```

For more details refer to [API reference](./reference/mip-sdk-reference.md).

## Next Steps

- Review the [File API - Process email .msg files (C++) quickstart](quick-email-msg-cpp.md)
- Review the [File API - Process email .msg files (C#) quickstart](quick-email-msg-csharp.md)